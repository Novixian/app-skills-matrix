<script src="https://unpkg.com/openpgp@2.3.5"></script>
<script>
const openpgp = window.openpgp

const encryptWithPassphrase = (password, data) =>
  openpgp.encrypt({
    data,
    passwords: [ password ],
  }).then(message => message.data)

const decryptWithPassphrase = (password, message) => 
  openpgp.decrypt({
    message: openpgp.message.readArmored(message),
    password,
  }).then(message => message.data)

const generateNewKeyPair = (passphrase, user) => 
  openpgp.generateKey({
    userIds: [ user ],
    numBits: 4096,
    passphrase
  }).then(key => [key.publicKeyArmored, key.privateKeyArmored])

const encryptWithPublicKeys = (publicKeys, data) => 
  Promise.all(publicKeys.map(publicKey =>
    openpgp.encrypt({
      data,
      publicKeys: openpgp.key.readArmored(publicKey).keys
    }).then(message => message.data)))

const decryptWithPrivateKey = (privateKey, passphrase, message) => {
  const decryptedPrivateKey = openpgp.key.readArmored(privateKey).keys[0]
  decryptedPrivateKey.decrypt(passphrase)
  return openpgp.decrypt({
    message: openpgp.message.readArmored(message),
    privateKey: decryptedPrivateKey,
  }).then(message => message.data)
}

const generateRandomSecret = (length=64, characterSet='abcdefghijklmnopqrstuvwxyz0123456789') =>
  Array.apply([], { length })
    .map(() => characterSet[openpgp.crypto.random.getSecureRandom(0,characterSet.length)])
    .join('')

const setFirstMessage = (passphrase, user, adminPublicKeys, message) => 
  generateNewKeyPair(passphrase, user)
    .then((user, secret = generateRandomSecret()) => 
      Promise.all([
        encryptWithPassphrase(secret, message),
        encryptWithPublicKeys([user[0]].concat(adminPublicKeys), secret)
      ]).then(([encryptedMessage, secrets]) => ({
          publicKey: user[0],
          privateKey: user[1],
          secrets,
          encryptedMessage
        })))

const getSecret = (passphrase, privateKey, secrets ) =>
  secrets.reduce((acc, secret) =>
    acc.then((result) => result 
      ? result
      : decryptWithPrivateKey(privateKey, passphrase, secret)
        .catch(err => null)), Promise.resolve())
    
//Test
const message = "random secret"
const passphrase = "passphrase"
const user = { name: 'Federico Rampazzo', email: 'ggdumbass@gmail.com'}

generateNewKeyPair(passphrase, user)
  .then(user => encryptWithPublicKeys([user[0]], message)
    .then(([encryptedMessage]) => decryptWithPrivateKey(user[1], passphrase, encryptedMessage))
    .then(decryptedMessage => console.log('message decryption', decryptedMessage, decryptedMessage === message)))
encryptWithPassphrase(passphrase, message)
  .then(encryptedMessage => decryptWithPassphrase(passphrase, encryptedMessage))
  .then(decryptedMessage => console.log('message decryption', decryptedMessage, decryptedMessage === message))

Promise.all([
  generateNewKeyPair(passphrase + '1', user),
  generateNewKeyPair(passphrase + '2', user),
  generateNewKeyPair(passphrase + '3', user)
]).then(adminKeys => setFirstMessage(passphrase, user, adminKeys.map(a => a[0]), message)
    .then(({ privateKey, secrets, encryptedMessage }) => Promise.all([
      getSecret(passphrase, privateKey, secrets)
        .then(decryptedSecret => decryptWithPassphrase(decryptedSecret, encryptedMessage)),
      getSecret(passphrase + '1', adminKeys[0][1], secrets)
        .then(decryptedSecret => decryptWithPassphrase(decryptedSecret, encryptedMessage)),
      getSecret(passphrase + '2', adminKeys[1][1], secrets)
        .then(decryptedSecret => decryptWithPassphrase(decryptedSecret, encryptedMessage)),
      getSecret(passphrase + '3', adminKeys[2][1], secrets)
        .then(decryptedSecret => decryptWithPassphrase(decryptedSecret, encryptedMessage)),
    ]).then(decryptedMessages => decryptedMessages.forEach(decryptedMessage => 
        console.log('message decryption', decryptedMessage, decryptedMessage === message)))
      .then(() => getSecret(passphrase + '4', privateKey, secrets)
        .then(empty =>  console.log('message decryption', empty, empty === null)))))
</script>